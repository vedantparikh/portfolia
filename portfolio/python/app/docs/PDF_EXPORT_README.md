# Transaction PDF Export Service

This module provides comprehensive PDF export and parsing functionality for transaction reports in the Portfolia application.

## Features

### PDF Export

- **Comprehensive Filtering**: Filter transactions by portfolio, date range, transaction types, asset symbols, and amount ranges
- **Summary Statistics**: Include detailed summary with totals, fees, taxes, and portfolio information
- **Professional Formatting**: Clean, professional PDF layout with tables, headers, and styling
- **Custom Filenames**: Generate filenames with user name, portfolio info, and timestamps
- **Multiple Export Options**: Direct download or response with metadata

### PDF Parsing

- **App PDF Recognition**: Automatically detect PDFs generated by this application
- **Transaction Extraction**: Parse transaction data from PDF tables
- **Summary Extraction**: Extract summary statistics from PDFs
- **Error Handling**: Comprehensive error reporting for parsing issues

## API Endpoints

### Export Endpoints

#### `POST /api/v1/transactions/pdf/export`

Export transactions to PDF and return metadata.

**Request Body:**

```json
{
  "filters": {
    "portfolio_ids": [1, 2],
    "start_date": "2023-01-01T00:00:00Z",
    "end_date": "2023-12-31T23:59:59Z",
    "transaction_types": ["buy", "sell"],
    "asset_symbols": ["AAPL", "GOOGL"],
    "min_amount": 100.0,
    "max_amount": 10000.0
  },
  "options": {
    "include_summary": true,
    "include_charts": false,
    "include_portfolio_details": true,
    "include_asset_details": true,
    "group_by_portfolio": false,
    "group_by_asset": false,
    "sort_by": "transaction_date",
    "sort_order": "desc"
  },
  "custom_filename": "my_transactions"
}
```

**Response:**

```json
{
  "filename": "transactions_john_doe_my_portfolio_20231208_143022.pdf",
  "file_size": 245760,
  "transaction_count": 156,
  "summary_stats": {
    "total_transactions": 156,
    "total_buy_volume": 45000.0,
    "total_sell_volume": 12000.0,
    "net_flow": -33000.0,
    "total_fees": 234.5,
    "total_taxes": 0.0,
    "unique_assets": 12,
    "date_range": "2023-01-01 to 2023-12-31",
    "portfolios_included": ["My Portfolio", "Growth Portfolio"]
  },
  "generated_at": "2023-12-08T14:30:22Z",
  "export_id": "a1b2c3d4-e5f6-7890-abcd-ef1234567890"
}
```

#### `POST /api/v1/transactions/pdf/export/download`

Export and directly download PDF file.

Same request body as above, returns PDF file directly with appropriate headers.

#### `GET /api/v1/transactions/pdf/export/preview`

Preview export without generating PDF.

Returns information about what would be included in the export:

```json
{
  "filename": "transactions_john_doe_20231208_143022.pdf",
  "transaction_count": 156,
  "summary_stats": { ... },
  "estimated_pages": 7,
  "filters_applied": { ... },
  "options": { ... }
}
```

### Parsing Endpoints

#### `POST /api/v1/transactions/pdf/parse`

Parse uploaded PDF file to extract transaction data.

**Form Data:**

- `file`: PDF file to parse
- `extract_transactions`: boolean (default: true)
- `extract_summary`: boolean (default: true)

**Response:**

```json
{
  "is_valid_app_pdf": true,
  "transactions": [
    {
      "asset_symbol": "AAPL",
      "asset_name": "Apple Inc.",
      "transaction_type": "buy",
      "quantity": 10.0,
      "price": 150.0,
      "total_amount": 1500.0,
      "fees": 5.0,
      "transaction_date": "2023-06-15T00:00:00Z",
      "notes": null,
      "reference_number": null
    }
  ],
  "summary": {
    "total_transactions": 156,
    "total_buy_volume": 45000.0,
    "total_sell_volume": 12000.0,
    "net_flow": -33000.0,
    "total_fees": 234.5,
    "date_range": "2023-01-01 to 2023-12-31",
    "portfolios_included": ["My Portfolio"]
  },
  "metadata": {
    "page_count": 7,
    "has_metadata": true
  },
  "parsing_errors": [],
  "parsed_at": "2023-12-08T14:30:22Z"
}
```

## Usage Examples

### Frontend Integration

The service is designed to work seamlessly with the existing React frontend:

```javascript
// Export PDF
const exportPDF = async (filters, options) => {
  const response = await fetch("/api/v1/transactions/pdf/export/download", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      Authorization: `Bearer ${token}`,
    },
    body: JSON.stringify({ filters, options }),
  });

  if (response.ok) {
    const blob = await response.blob();
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = response.headers
      .get("Content-Disposition")
      .split("filename=")[1];
    a.click();
  }
};

// Parse PDF
const parsePDF = async (file) => {
  const formData = new FormData();
  formData.append("file", file);

  const response = await fetch("/api/v1/transactions/pdf/parse", {
    method: "POST",
    headers: {
      Authorization: `Bearer ${token}`,
    },
    body: formData,
  });

  return await response.json();
};
```

### Python Service Usage

```python
from core.services.transaction_pdf_service import TransactionPDFService
from core.schemas.pdf_export import TransactionExportFilters, PDFExportOptions

# Initialize service
pdf_service = TransactionPDFService(db)

# Create filters
filters = TransactionExportFilters(
    portfolio_ids=[1, 2],
    start_date=datetime(2023, 1, 1),
    transaction_types=[TransactionType.BUY, TransactionType.SELL]
)

# Create options
options = PDFExportOptions(
    include_summary=True,
    sort_by="transaction_date",
    sort_order="desc"
)

# Export PDF
pdf_bytes, response_data = await pdf_service.export_transactions_to_pdf(
    user=current_user,
    filters=filters,
    options=options
)

# Parse PDF
parse_result = await pdf_service.parse_pdf(pdf_bytes)
```

## File Structure

```
app/
├── core/
│   ├── schemas/
│   │   └── pdf_export.py          # Pydantic schemas for requests/responses
│   └── services/
│       └── transaction_pdf_service.py  # Main PDF service implementation
└── api/
    └── v1/
        └── transactions/
            ├── __init__.py         # Updated to include PDF router
            └── pdf_router.py       # FastAPI endpoints for PDF operations
```

## Dependencies

The following packages were added to `requirements.txt`:

- `reportlab==4.0.4` - PDF generation
- `pypdf==3.17.1` - PDF parsing
- `PyPDF2==3.0.1` - Additional PDF support (existing)

## Security Considerations

- All endpoints require authentication
- File upload validation for PDF parsing
- User-specific data filtering (users can only export their own transactions)
- Comprehensive error handling and logging
- Input validation and sanitization

## Performance Notes

- PDF generation is optimized for large datasets
- Pagination support for very large transaction sets
- Efficient database queries with proper joins
- Memory-efficient PDF processing
- Background processing support (can be extended for async generation)

## Future Enhancements

- Chart and graph inclusion in PDFs
- Multiple export formats (Excel, CSV)
- Scheduled PDF generation
- Email delivery of reports
- Template customization
- Batch processing for multiple portfolios
